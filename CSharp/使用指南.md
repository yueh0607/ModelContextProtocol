# MCP Server HTTP 调试程序 - 使用指南

## 概述

这是一个基于 Model Context Protocol (MCP) 的 HTTP Server 控制台调试程序，实现了完整的 MCP 协议和基于 HTTP 的通信。

## 项目结构

```
CSharp/
├── ModelContextProtocol.Core/          # MCP 核心库
│   └── Server/
│       └── Transport/
│           ├── IMcpTransport.cs       # 传输层接口
│           ├── StdioTransport.cs      # STDIO 传输实现
│           └── HttpTransport.cs       # HTTP 传输实现（新增）
├── McpServerConsole/                   # 控制台服务器程序
│   ├── Program.cs                     # 主程序
│   ├── README.md                      # 详细文档
│   └── McpServerConsole.csproj
├── McpTestClient/                      # HTTP 测试客户端
│   ├── Program.cs                     # 测试客户端
│   └── McpTestClient.csproj
├── start-server.ps1                    # 启动服务器脚本
├── test-client.ps1                     # 运行测试客户端脚本
└── simple-test.ps1                     # 快速测试脚本
```

## 快速开始

### 方法 1: 使用 PowerShell 脚本（推荐）

#### 步骤 1: 启动服务器

在 PowerShell 中运行：

```powershell
cd D:\Coding\CSWorkspace\ModelContextProtocol\CSharp
.\start-server.ps1
```

或者手动启动：

```powershell
cd McpServerConsole
dotnet run
```

你应该看到类似的输出：

```
========================================
     MCP Server HTTP 控制台调试程序
========================================

[启动] 使用 HTTP 传输，端口: 8767
[启动] 已注册 4 个工具

可用工具:
  - echo: 回显传入的消息。参数: message (string)
  - calculator: 执行数学计算。参数: a (number), b (number), operation (add/subtract/multiply/divide)
  - get_system_info: 获取系统信息
  - delay: 延迟指定毫秒数。参数: milliseconds (number)

[就绪] MCP 服务器已启动，等待连接...
按 Ctrl+C 停止服务器

[HTTP] HTTP Server started on http://localhost:8767/
```

#### 步骤 2: 测试服务器

**选项 A: 使用快速测试脚本**

在另一个 PowerShell 窗口中：

```powershell
cd D:\Coding\CSWorkspace\ModelContextProtocol\CSharp
.\simple-test.ps1
```

**选项 B: 使用完整的测试客户端**

```powershell
cd D:\Coding\CSWorkspace\ModelContextProtocol\CSharp
.\test-client.ps1
```

交互模式：

```powershell
.\test-client.ps1 -i
```

### 方法 2: 直接使用 dotnet 命令

#### 启动服务器

```powershell
cd McpServerConsole
dotnet build
dotnet run
```

#### 运行测试客户端

```powershell
# 在另一个终端
cd McpTestClient
dotnet build
dotnet run
```

### 方法 3: 使用 curl 或 PowerShell 手动测试

#### 测试服务器连接

```powershell
Invoke-WebRequest -Uri "http://localhost:8767" -Method GET
```

或使用 curl：

```bash
curl http://localhost:8767
```

#### 发送 JSON-RPC 请求

**初始化连接：**

```powershell
$body = @{
    jsonrpc = "2.0"
    id = 1
    method = "initialize"
    params = @{
        protocolVersion = "2024-11-05"
        capabilities = @{}
        clientInfo = @{
            name = "Manual Test"
            version = "1.0.0"
        }
    }
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "http://localhost:8767" -Method POST -Body $body -ContentType "application/json"
```

**获取工具列表：**

```powershell
$body = @{
    jsonrpc = "2.0"
    id = 2
    method = "tools/list"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8767" -Method POST -Body $body -ContentType "application/json"
```

**调用 echo 工具：**

```powershell
$body = @{
    jsonrpc = "2.0"
    id = 3
    method = "tools/call"
    params = @{
        name = "echo"
        arguments = @{
            message = "Hello MCP!"
        }
    }
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "http://localhost:8767" -Method POST -Body $body -ContentType "application/json"
```

**调用计算器工具：**

```powershell
$body = @{
    jsonrpc = "2.0"
    id = 4
    method = "tools/call"
    params = @{
        name = "calculator"
        arguments = @{
            a = 10
            b = 5
            operation = "multiply"
        }
    }
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "http://localhost:8767" -Method POST -Body $body -ContentType "application/json"
```

## 内置工具说明

### 1. echo
回显传入的消息

**参数：**
- `message` (string): 要回显的消息

**示例：**
```json
{
  "name": "echo",
  "arguments": {
    "message": "Hello World"
  }
}
```

### 2. calculator
执行基本数学运算

**参数：**
- `a` (number): 第一个数字
- `b` (number): 第二个数字
- `operation` (string): add / subtract / multiply / divide

**示例：**
```json
{
  "name": "calculator",
  "arguments": {
    "a": 10,
    "b": 5,
    "operation": "add"
  }
}
```

### 3. get_system_info
获取系统信息

**参数：** 无

**返回：** JSON 格式的系统信息

### 4. delay
异步延迟工具（用于测试异步操作）

**参数：**
- `milliseconds` (number): 延迟的毫秒数

## 命令行选项

### MCP Server

```powershell
dotnet run -- [选项]

选项:
  --port <端口>        指定 HTTP 端口（默认: 8767）
  --transport <类型>   传输类型：http 或 stdio（默认: http）
```

**示例：**

```powershell
# 使用 9000 端口
dotnet run -- --port 9000

# 使用 STDIO 传输
dotnet run -- --transport stdio
```

### 测试客户端

```powershell
dotnet run -- [选项]

选项:
  --url <地址>         服务器地址（默认: http://localhost:8767）
  --interactive, -i    交互式模式
```

**示例：**

```powershell
# 连接到不同端口
dotnet run -- --url http://localhost:9000

# 交互式模式
dotnet run -- --interactive
```

## 故障排除

### 问题 1: 端口已被占用

**错误信息：** "通常每个套接字地址(协议/网络地址/端口)只允许使用一次"

**解决方案：**

1. 停止占用端口的进程：
```powershell
Get-Process -Name "dotnet" | Stop-Process -Force
```

2. 或使用不同的端口：
```powershell
dotnet run -- --port 9000
```

### 问题 2: 无法连接到服务器

**错误信息：** "无法连接。远程主机强迫关闭了一个现有的连接"

**解决方案：**

1. 确认服务器正在运行
2. 检查端口是否正确
3. 查看服务器日志输出

### 问题 3: 服务器启动失败

**排查步骤：**

1. 检查编译错误：
```powershell
cd McpServerConsole
dotnet build
```

2. 查看详细错误信息（前台运行）：
```powershell
dotnet run
```

## 开发和扩展

### 添加新工具

在 `McpServerConsole/Program.cs` 的 `RegisterTools` 方法中添加：

```csharp
toolCollection.Add(SimpleMcpServerTool.Create(
    name: "my_custom_tool",
    description: "我的自定义工具描述",
    handler: async (args, ct) =>
    {
        // 获取参数
        string param1 = args["param1"]?.ToString();
        int param2 = args["param2"]?.ToObject<int>() ?? 0;
        
        // 执行逻辑
        string result = $"处理结果: {param1}, {param2}";
        
        // 返回结果
        return new CallToolResult
        {
            Content = new List<ContentBlock>
            {
                new TextContentBlock { Text = result }
            }
        };
    }
));
```

### 创建自定义传输层

实现 `IMcpTransport` 接口：

```csharp
public class MyCustomTransport : IMcpTransport
{
    public Task<string> ReadMessageAsync(CancellationToken cancellationToken) { }
    public Task WriteMessageAsync(string message, CancellationToken cancellationToken) { }
    public Task StartAsync(CancellationToken cancellationToken) { }
    public void Stop() { }
}
```

## 技术细节

### 架构组件

1. **传输层 (Transport Layer)**
   - `HttpTransport`: HTTP POST 请求/响应模式
   - `StdioTransport`: 标准输入/输出流
   - `IMcpTransport`: 传输层接口

2. **服务器核心 (Server Core)**
   - `TransportBasedMcpServer`: 基于传输层的 MCP 服务器
   - `McpServerOptions`: 服务器配置选项
   - `McpRequestHandler`: 请求处理器

3. **工具系统 (Tool System)**
   - `SimpleMcpServerTool`: 简化的工具基类
   - `IMcpServerPrimitive`: 服务器原语接口

4. **协议 (Protocol)**
   - JSON-RPC 2.0
   - MCP 协议版本: 2024-11-05

### HTTP 传输特性

- 每个 HTTP POST 请求对应一次 JSON-RPC 消息交换
- 支持 GET 请求返回服务器信息
- 自动处理连接管理和清理
- 线程安全的读写操作

## 相关资源

- [Model Context Protocol 官网](https://modelcontextprotocol.io/)
- [JSON-RPC 2.0 规范](https://www.jsonrpc.org/specification)
- [MCP GitHub](https://github.com/modelcontextprotocol)

## 许可证

MIT License

